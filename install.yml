---
- hosts: localhost
  become: true
  tasks:
    - name: Get Profile variables
      include_vars: "profiles/{{ profile }}.yml"
      when: profile is defined

    - name: Get Os variables if no profile
      include_vars: "os_{{ ansible_facts['distribution'] }}.yml"
      when: profile is undefined

    - name: Create Workspaces directory
      file:
        path: "{{ home_dir }}/{{ workspace_dir }}"
        owner: "{{ username }}"
        group: "{{ group | default(username) }}"
        state: directory

    - name: Install IDE
      block:
        - debug:
            var: ide_packages

        - name: Install IDE packages
          shell: "sudo -u {{ username }} {{ install_command }} {{ item }}"
          with_items:
            - "{{ ide_packages }}"
          ignore_errors: true

        - name: Init IDE configurations
          include_tasks: "tasks/{{ item }}.yml"
          with_items:
            - "{{ ide_config }}"

        - name: Copy user local directory
          copy:
            src: .local/
            dest: "{{ home_dir }}/.local"
            owner: "{{ username }}"
            group: "{{ group | default(username) }}"
            directory_mode: yes
            remote_src: yes

        - name: Copy environment configuration
          copy:
            src: .env
            dest: "{{ home_dir }}/.env"
            owner: "{{ username }}"
            group: "{{ group | default(username) }}"
            remote_src: yes

        - name: Copy aliases
          copy:
            src: .aliases
            dest: "{{ home_dir }}/.aliases"
            owner: "{{ username }}"
            group: "{{ group | default(username) }}"
            remote_src: yes

        - name: Set default shell
          shell: "sudo usermod --shell /bin/{{ default_shell }} {{ username }}"
          ignore_errors: true
              
        - name: Set default keyboard layout using setxkbmap
          shell: "sudo -u {{ username }} setxkbmap -layout {{ default_keyboard }}"
          when: default_keyboard is defined
      when: ide_install

    - name: Install system environment
      block:
        - debug:
            var: system_packages

        - name: Install system packages
          shell: "sudo -u {{ username }} {{ install_command }} {{ item }}"
          with_items:
            - "{{ system_packages }}"
          ignore_errors: true

        - name: Init system configurations
          include_tasks: "tasks/{{ item }}.yml"
          with_items:
            - "{{ system_config }}"
          when: system_config is defined
      when: system_install

    - name: Install general packages
      block:
        - debug:
            var: general_packages

        - name: Install general packages
          shell: "sudo -u {{ username }} {{ install_command }} {{ item }}"
          with_items:
            - "{{ general_packages }}"
          ignore_errors: true

        - name: Init general configurations
          include_tasks: "tasks/{{ item }}.yml"
          with_items:
            - "{{ general_config }}"
          when: general_config is defined
      when: general_install
