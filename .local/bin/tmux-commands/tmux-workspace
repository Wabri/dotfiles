#!/usr/bin/env bash
workspace_dir=~/Documents/Workspaces

fzf_args='--border=rounded --margin=2,4,2,4 --layout=reverse --keep-right'

case "$1" in
"full")
    project_fullpath=`ls -d $workspace_dir/*/*/* | fzf --prompt='Choose the project>' ${fzf_args}`

    if [ -z $project_fullpath ]; then
        exit 1
    fi

    group=`echo $project_fullpath | awk -F "/" '{print $(NF-2)}'`
    scope=`echo $project_fullpath | awk -F "/" '{print $(NF-1)}'`
    project_basename=`echo $project_fullpath | awk -F "/" '{print $(NF)}'`
    ;;
"steps")
    group=`basename -a $(ls -d $workspace_dir/*) | fzf --prompt='Group>' ${fzf_args}`

    if [ -z $group ]; then
        exit 1
    fi

    scope=`basename -a $(ls -d $workspace_dir/$group/*) | fzf --prompt='Scope>' ${fzf_args}`

    if [ -z $scope ]; then
        exit 1
    fi

    project_basename=`basename -a $(ls -d $workspace_dir/$group/$scope/*) | fzf --prompt='Project>' ${fzf_args}`

    if [ -z $project_basename ]; then
        exit 1
    fi
    ;;
*)
    exit 1
    ;;
esac

project_fullname=$group/$scope/$project_basename

echo $project_fullname

tmux has-session -t $project_fullname >/dev/null

[ -z "${TMUX}" ] && tmux attach-session -t $project_fullname && exit 0

if [ $? != 0 ]; then
  tmux new-session -d -s $project_fullname -c $workspace_dir/$project_fullname/main-dev
  tmux rename-window -t $project_fullname:1 "main-dev"
  tmux send-keys 'vim' 'C-m'
  tmux split-window -v -l 20% -c "$workspace_dir/$project_fullname/main-dev"
  tmux split-window -h -l 40% -c "$workspace_dir/$project_fullname/main-dev"
fi

tmux switch-client -t $project_fullname
